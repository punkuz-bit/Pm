---
import Base from "../../layouts/Base.astro";

export async function getStaticPaths() {
  const modules = import.meta.glob('../../../content/books/*.mdx');
  return Object.keys(modules).map((filepath) => {
    const slug = filepath.split('/').pop()?.replace('.mdx','') || '';
    return { params: { slug } };
  });
}

const modules = import.meta.glob('../../../content/books/*.mdx');
const entry = Object.entries(modules).find(([path]) => path.endsWith(`${Astro.params.slug}.mdx`));

if (!entry) throw new Error(`Book not found for slug: ${Astro.params.slug}`);

const mod: any = await entry[1]();
const { Content, frontmatter } = mod;
const { title, description, cover, date, tags = [], buy = '' } = frontmatter || {};
---

<Base title={title} description={description}>
  <style>
    .tag{display:inline-flex;align-items:center;padding:.2rem .55rem;border:1px solid #e5e7eb;border-radius:999px;font-size:.75rem;margin-right:.4rem;margin-bottom:.4rem}
  </style>

  <div class="max-w-3xl mx-auto px-4 py-10">
    <p><a href="/books" class="text-indigo underline">← Back to Books</a></p>

    <div class="mt-3">
      <h1 class="text-3xl font-bold">{title}</h1>
      {date && <div class="text-sm text-gray-500 mt-1">{date}</div>}
      <div class="text-sm text-gray-600 mt-1">
        Published by <a class="underline" href="https://himantrix.com" target="_blank" rel="noopener">HiMantrix Publishing</a>
      </div>
    </div>

    {tags.length > 0 && (
      <div class="mt-3 -m-1">
        {tags.map(t => <span class="tag" key={t}>{t}</span>)}
      </div>
    )}

    {cover && (
  <div class="mt-5 bg-black/40 rounded-xl border border-white/15 p-3 flex justify-center">
    <img src={cover} alt={title} class="max-h-[480px] w-auto object-contain" />
  </div>
)}


    <div class="mt-5 flex gap-2 flex-wrap">
      {buy && <a class="btn btn-primary" href={buy} target="_blank" rel="noopener">Buy on Amazon</a>}
      <a class="btn btn-outline" href="https://himantrix.com" target="_blank" rel="noopener">Imprint: HiMantrix →</a>
    </div>

    <div class="prose max-w-none mt-6">
      <Content />
    </div>
  </div>
</Base>
